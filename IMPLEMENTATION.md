# 实现说明

## 项目概述

**subnet_states** 是一个网络评估工具，用于在执行主动网络扫描前进行轻量级的子网健康度评估，输出安全的扫描速率等级（Level 1-5）。采用**策略与执行分离**的设计模式，作为决策大脑调度 scout 工具进行数据采集。

## 项目结构

```
subnet_states/
├── README.md                    # 项目说明
├── CLAUDE.md                    # Claude 开发指南
├── IMPLEMENTATION.md            # 本文件 - 实现说明
├── USAGE.md                     # 使用说明
├── requirements.txt             # Python 依赖
├── setup.py                     # 安装脚本
│
├── conf/
│   └── config.yaml              # 配置文件（阈值、权重、速率等级）
│
├── src/
│   ├── __init__.py
│   ├── main.py                  # 【接口层】CLI 入口（Click 框架）
│   │
│   ├── models/                  # 【数据模型层】
│   │   ├── device.py            # NetworkDevice、DeviceMetrics 数据类
│   │   └── subnet.py            # Subnet 数据类
│   │
│   ├── core/                    # 【核心算法层】纯数学计算
│   │   ├── calculator.py        # 指标归一化、动态权重、得分计算
│   │   └── topology.py          # 拓扑分析、介数中心性计算
│   │
│   ├── services/                # 【业务逻辑层】
│   │   └── assessor.py          # 分层评估流程（两层评估）
│   │
│   └── adapters/                # 【适配器层】外部工具集成
│       ├── scout.py             # Scout 工具实现（dnmap + PySNMP）
│       └── scout_client.py      # Scout 客户端封装
│
└── tests/
    └── test_basic.py            # 基础功能测试
```

## 四层架构设计

```
┌─────────────────────────────────────────────────────────────┐
│  接口层 (src/main.py)                                        │
│  - Click CLI 框架                                            │
│  - 参数: --target, --config, --verbose, --output            │
│  - 支持文本和 JSON 两种输出格式                               │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│  业务逻辑层 (src/services/assessor.py)                       │
│  - SubnetAssessor 类                                         │
│  - 两层评估流程（快速路径 + 详细分析）                         │
│  - 配置加载与管理                                             │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│  核心算法层 (src/core/)                                       │
│  - calculator.py: 指标归一化、动态权重、得分计算               │
│  - topology.py: 拓扑分析、介数中心性计算                       │
│  - 纯数学计算，无外部依赖                                      │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│  适配器层 (src/adapters/)                                     │
│  - scout.py: dnmap + PySNMP 实现                             │
│  - scout_client.py: Scout 客户端封装                          │
│  - 外部工具不可用时自动降级为模拟数据                          │
└─────────────────────────────────────────────────────────────┘
```

## 两层评估流程

```
用户输入 subnet_cidr
        │
        ▼
┌───────────────────────┐
│ 设备发现 (scout)       │
│ ICMP Ping + SNMP 验证  │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│ 第一层: 快速评估       │
│ 检查所有设备 POR < 0.5 │
└───────────┬───────────┘
            │
    ┌───────┴───────┐
    │ YES           │ NO
    ▼               ▼
返回 level_5   ┌───────────────────────┐
               │ 第二层: 详细评估       │
               │ 1. 采集完整指标        │
               │ 2. 计算动态权重        │
               │ 3. 计算设备得分        │
               │ 4. 构建拓扑            │
               │ 5. 计算介数中心性      │
               │ 6. 计算子网综合得分    │
               └───────────┬───────────┘
                           │
                           ▼
                   确定速率等级 (1-5)
```

### 第一层：冗余容量评估（快速路径）

- 快速检查所有设备的 POR（端口占用率）
- 如果所有设备 POR < 阈值（默认 0.5），直接返回 level_5
- 避免不必要的详细评估，提高效率

### 第二层：综合状态评估（详细分析）

1. 采集完整指标（POR, PAR, IER, QDR）
2. 计算动态权重（基于变异系数）
3. 计算单设备得分
4. 获取路由表构建拓扑
5. 计算介数中心性
6. 加权计算子网综合得分
7. 根据得分确定速率等级

## 完整数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户输入                                   │
│                  python -m src.main --target 192.168.1.0/24      │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
        ┌────────────────────────────────────┐
        │   main.py (接口层)                  │
        │  - 解析 CLI 参数                    │
        │  - 初始化 Scout 客户端              │
        │  - 创建 SubnetAssessor              │
        └────────────┬───────────────────────┘
                     │
                     ▼
        ┌────────────────────────────────────┐
        │  assessor.py (业务逻辑层)           │
        │  assess(subnet_cidr)                │
        └────────────┬───────────────────────┘
                     │
        ┌────────────┴───────────────────────┐
        │                                    │
        ▼                                    ▼
   ┌─────────────────┐          ┌──────────────────────┐
   │ scout.discover()│          │ 第一层评估            │
   │ 设备发现        │          │ check_redundancy()   │
   └────────┬────────┘          └──────────┬───────────┘
            │                              │
            ▼                              ▼
   ┌─────────────────────────────────────────────────┐
   │ 所有设备 POR < 阈值？                            │
   └────────┬──────────────────────────┬─────────────┘
            │ YES                      │ NO
            ▼                          ▼
      返回 level_5              ┌──────────────────────┐
                                │ 第二层评估            │
                                │ comprehensive_assess()│
                                └──────────┬───────────┘
                                           │
                    ┌──────────────────────┼──────────────────────┐
                    │                      │                      │
                    ▼                      ▼                      ▼
            ┌──────────────┐      ┌──────────────┐      ┌──────────────┐
            │ scout.fetch_ │      │ 计算动态权重  │      │ scout.fetch_ │
            │ metrics()    │      │ dynamic_     │      │ topology()   │
            │ 采集指标     │      │ weights()    │      │ 获取路由表   │
            └──────┬───────┘      └──────┬───────┘      └──────┬───────┘
                   │                     │                     │
                   └─────────────────────┼─────────────────────┘
                                         │
                                         ▼
                            ┌────────────────────────┐
                            │ 计算单设备得分          │
                            │ calculate_device_score()│
                            └────────────┬───────────┘
                                         │
                                         ▼
                            ┌────────────────────────┐
                            │ 构建拓扑                │
                            │ build_topology_from_   │
                            │ routes()               │
                            └────────────┬───────────┘
                                         │
                                         ▼
                            ┌────────────────────────┐
                            │ 计算介数中心性          │
                            │ calculate_betweenness_ │
                            │ centrality()           │
                            └────────────┬───────────┘
                                         │
                                         ▼
                            ┌────────────────────────┐
                            │ 计算子网综合得分        │
                            │ calculate_subnet_score()│
                            └────────────┬───────────┘
                                         │
                                         ▼
                            ┌────────────────────────┐
                            │ 确定速率等级            │
                            │ determine_rate_level() │
                            └────────────┬───────────┘
                                         │
                                         ▼
                    ┌────────────────────────────────┐
                    │ 返回评估结果                    │
                    │ {score, rate_level, devices...}│
                    └────────────┬───────────────────┘
                                 │
                                 ▼
                    ┌────────────────────────────────┐
                    │ main.py 格式化输出              │
                    │ 文本或 JSON 格式                │
                    └────────────────────────────────┘
```

## 核心指标体系

| 指标 | 缩写 | 含义 | 范围 | 来源 |
|------|------|------|------|------|
| 端口占用率 | POR | 物理端口被占用的比例 | 0.0-1.0 | IF-MIB |
| 端口异常率 | PAR | 已占用端口中异常的比例 | 0.0-1.0 | IF-MIB |
| 接口误码率 | IER | 输入错误包数/总输入包数 | 0.0-1.0 | IP-MIB |
| 队列丢包率 | QDR | 输出丢弃包数/总输出包数 | 0.0-1.0 | IP-MIB |

**特点**：所有指标都是"越小越好"，归一化时反转使得高分代表健康状态。

## 速率等级映射

| 等级 | 得分范围 | 描述 | 建议 |
|------|----------|------|------|
| level_5 | >= 90 | 极高速 | 可以使用最高速率扫描 |
| level_4 | >= 75 | 高速 | 可以使用高速扫描 |
| level_3 | >= 60 | 中速 | 使用中等速率扫描 |
| level_2 | >= 40 | 低速 | 使用低速扫描 |
| level_1 | < 40 | 极低速 | 使用极低速扫描或暂停 |

## 核心算法实现

### 1. 指标归一化 (`MetricCalculator.normalize_metric`)

基于科学计数法的分段函数，处理不同量级的指标：

```
power < -3:     得分 95-100（极小值，如 0.0001）
-3 <= power < 0: 得分 85-95（很小值，如 0.01）
power = 0:      得分 60-85（0-1 范围，如占用率 0.5）
0 < power <= 5:  得分 20-60（中等值）
5 < power <= 10: 得分 1-20（大值）
power > 10:     得分 1（超出范围）
```

### 2. 动态权重计算 (`MetricCalculator.calculate_dynamic_weights`)

- 基于标准差系数（变异系数 CV = std_dev / mean）
- 数据波动大的指标权重更高
- 权重范围限制：0.1-0.4
- 权重总和归一化为 1.0

### 3. 介数中心性计算 (`TopologyAnalyzer.calculate_betweenness_centrality`)

- 使用 `networkx` 库实现
- 衡量节点在最短路径中出现的频率
- 识别网络中的关键转发节点

### 4. 子网综合得分 (`MetricCalculator.calculate_subnet_score`)

**公式**：
```
S_subnet = Σ (1 - C_B(v)) × S_device(v) / |devices|
```

- `C_B(v)`: 设备 v 的介数中心性
- `S_device(v)`: 设备 v 的得分
- 关键设计：高中心性节点权重降低 `(1 - C_B)`，使其性能问题更明显

## Scout 工具集成

### 实现方式 (`src/adapters/scout.py`)

- **设备发现**: 使用 dnmap ICMP Ping 扫描
- **指标采集**: 使用 PySNMP 双采样法计算速率指标
- **拓扑获取**: 读取设备路由表

### SNMP OID 列表

| OID | 名称 | 用途 |
|-----|------|------|
| 1.3.6.1.2.1.4.3.0 | ipInReceives | 输入包计数 |
| 1.3.6.1.2.1.4.10.0 | ipOutRequests | 输出包计数 |
| 1.3.6.1.2.1.4.8.0 | ipInDiscards | 输入丢弃计数 |
| 1.3.6.1.2.1.4.4.0 | ipInHdrErrors | 头部错误计数 |
| 1.3.6.1.2.1.4.5.0 | ipInAddrErrors | 地址错误计数 |

### 模拟数据模式

- 当 dnmap 或 pysnmp 不可用时，自动使用模拟数据
- 模拟数据会明确标注 `[MOCK]`
- 便于开发和测试

## 配置文件 (`conf/config.yaml`)

```yaml
# 第一层评估阈值
redundancy:
  por_threshold: 0.5  # 端口占用率阈值

# 第二层评估参数
comprehensive:
  normalization:
    max_power: 10        # 最大科学计数法幂次
    most_freq_power: 5   # 最常见幂次
  weight:
    use_std_coefficient: true  # 使用标准差系数
    min_weight: 0.1      # 最小权重
    max_weight: 0.4      # 最大权重
  topology:
    use_betweenness: true      # 使用介数中心性
    normalize_centrality: true # 归一化中心性

# 速率等级划分
rate_levels:
  level_5: {min_score: 90, description: "极高速度"}
  level_4: {min_score: 75, description: "高速"}
  level_3: {min_score: 60, description: "中速"}
  level_2: {min_score: 40, description: "低速"}
  level_1: {min_score: 0,  description: "极低速"}

# Scout 工具配置
scout:
  path: "scout"
  timeout: 30
  retry_count: 3

# 日志配置
logging:
  level: "INFO"
  format: "[%(levelname)s] %(message)s"
```

## 退出码

| 退出码 | 含义 |
|--------|------|
| 0 | 成功（得分 >= 60） |
| 1 | 低分警告（得分 < 60） |
| 130 | 用户中断（Ctrl+C） |

## 测试

运行基础功能测试：

```bash
python tests/test_basic.py
```

测试覆盖：
- `test_device_metrics()` - 设备指标数据模型
- `test_network_device()` - 网络设备数据模型
- `test_normalize_metric()` - 指标归一化
- `test_dynamic_weights()` - 动态权重计算
- `test_device_score()` - 设备得分计算
- `test_betweenness_centrality()` - 介数中心性计算

## 注意事项

### 1. 安全问题

`scout.py` 中硬编码了 sudo 密码，建议改用环境变量：

```python
# 当前实现（不安全）
SUDO_PASSWORD = '14qiguaidemeng'

# 建议改为
SUDO_PASSWORD = os.environ.get('SUDO_PASSWORD', '')
```

### 2. 依赖要求

- **dnmap**: 需要 `/home/lihaihong/dnmap/data_plane/run_core.sh` 可执行
- **pysnmp**: `pip install pysnmp`
- **networkx**: `pip install networkx`
- **numpy**: `pip install numpy`
- **click**: `pip install click`
- **pyyaml**: `pip install pyyaml`

### 3. 权限要求

- ICMP Ping 扫描需要 root 权限
- SNMP 采集需要网络访问权限

### 4. 模拟数据

- 当 scout 工具不可用时，程序会使用模拟数据
- 模拟数据仅用于测试，实际部署需要真实的 scout 工具
- 模拟数据会在日志中标注 `[MOCK]`

## 后续改进建议

1. **安全改进**: 将硬编码密码改为环境变量或密钥管理系统
2. **更多测试**: 添加集成测试、性能测试
3. **性能优化**: 对于大规模子网，可以考虑并行采集指标
4. **缓存机制**: 对于相同子网的重复评估，可以缓存结果
5. **Web API**: 可以添加 RESTful API 接口，方便集成到其他系统

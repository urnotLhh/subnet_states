
# subnet_states

## 📖 项目简介

**subnet_states** 是一个用于 **子网状态评估与扫描速率决策** 的策略模块，运行于 Linux 环境下。

在进行主动物联网设备指纹收集（如资产测绘）前，直接对目标子网发送大量探测流量可能导致网络拥塞甚至设备瘫痪。本项目旨在解决这一问题，通过对目标子网进行“轻量级”的实时负载状态评估，输出安全的 **扫描速率等级（Rate Level）**。

它不直接进行底层发包，而是作为 **决策大脑**，调度探测工具（`scout`）获取数据，基于多维指标和拓扑分析算法，判断子网的承载能力。

---

## 🚀 核心特性

* **轻量级前置评估**：在执行高强度扫描前，先进行低负载的健康度检查，保障网络稳定性。
* **分层评估模型**：
    * **第一层：冗余容量评估**（快速筛选）：基于端口占用率（POR）快速判断子网是否具备高承载力。
    * **第二层：综合状态评估**（深度分析）：针对高负载子网，结合误码率、丢包率及拓扑结构进行精准判定。
* **拓扑感知**：通过路由表构建子网拓扑，计算 **介数中心性（Betweenness Centrality）**，识别关键节点（Key Nodes），防止关键路径过载。
* **动态权重算法**：基于数据分布的归一化方案与基于标准差的动态权重计算，确保评分的客观性。

---

## 🛠️ 架构与工作流

本项目采用 **策略与执行分离** 的设计模式：

1.  **策略层 (`subnet_states`)**：
    * 输入：目标子网网段（CIDR）。
    * 逻辑：执行状态评估算法，计算综合得分。
    * 输出：子网负载等级（决定后续扫描工具的速率）。
2.  **执行层 (`scout`)**：
    * **subnet_states** 调用外部工具 `scout` 进行实际的数据采集。
    * 任务包括：ICMP 存活探测、SNMP (Port 161) 指标采集、路由表获取。

```mermaid
graph LR
    A[User Input: Subnet] --> B(subnet_states);
    B -- 指令: 探测可达性/采集SNMP --> C[scout 工具];
    C -- 返回: 响应数据/MIB信息 --> B;
    B -- 算法处理 --> D[输出: 负载等级/速率策略];

```

---

## 📊 评估指标体系

本模型主要通过 SNMP 采集网络转发设备（交换机/路由器）的以下关键指标：

| 指标名称 | 缩写 | 描述 | 来源 (SNMP MIB) |
| --- | --- | --- | --- |
| **端口占用率** | **POR** | 设备物理非空槽位的端口比例，反映接入规模。 | `IF-MIB::ifNumber`, `ifOperStatus(6)` |
| **端口异常率** | **PAR** | 已占用端口中处于异常状态（Down/Testing）的比例，反映链路健康度。 | `ifOperStatus(2,3,7)` |
| **接口误码率** | **IER** | 输入错误包数占总输入包数的比例，评估链路层传输质量。 | `ifInErrors`, `ifInUcastPkts` |
| **队列丢包率** | **QDR** | 输出丢弃包数占总输出包数的比例，反映拥塞处理能力。 | `ifOutDiscards`, `ifOutUcastPkts` |

此外，还通过 `IP-FORWARD-MIB::ipCidrRouteDest` 获取路由表信息以构建网络拓扑。

---

## 🧮 算法逻辑

### 1. 分层评估机制

* **快速通过**：若子网内所有设备的 **POR** 小于阈值，判定冗余容量充足，直接返回高等级速率。
* **详细评估**：若未通过，进入综合评估阶段。

### 2. 单设备评分

* **数据归一化**：采用基于科学计数法的分段函数，将不同量级的指标（如丢包率 vs 占用率）映射到 1-100 范围。
* **动态加权**：根据采样周期内指标的 **标准差系数** 动态分配权重，数据波动大的指标权重更高。

### 3. 子网整体评分 (结合拓扑)

* **介数中心性 ()**：计算每个设备在网络最短路径中出现的频率。 越高的设备越关键。
* **综合得分 ()**：
$$ S_{subnet} = \sum (1 - C_{B}(v)) \times S_{device}(v) $$
关键设备的性能下降会对子网整体得分产生更严重的负面影响。

---

## 📦 依赖说明

* **操作系统**: Linux
* **Python 依赖**:
  - `python-nmap`: Nmap Python 封装，用于设备发现
  - `pysnmp`: SNMP 协议库，用于指标采集
  - `numpy`, `networkx`: 数值计算和图算法
* **系统依赖**: Nmap (需预先安装: `apt install nmap` 或 `yum install nmap`)

## 📖 使用说明

### 安装依赖

```bash
# 安装系统依赖 (Nmap)
sudo apt install nmap  # Debian/Ubuntu
# 或
sudo yum install nmap  # CentOS/RHEL

# 安装 Python 依赖
pip install -r requirements.txt
```

或者使用 setup.py 安装：

```bash
pip install -e .
```

### 命令行使用

```bash
# 基本用法
python -m src.main --target 192.168.1.0/24

# 使用详细日志
python -m src.main --target 192.168.1.0/24 --verbose

# 输出 JSON 格式
python -m src.main --target 192.168.1.0/24 --output json

# 指定 SNMP 团体名 (默认 public)
python -m src.main --target 192.168.1.0/24 --snmp-community private

# 指定配置文件
python -m src.main --target 192.168.1.0/24 --config conf/config.yaml
```

### 安装后使用

如果使用 `pip install -e .` 安装后，可以直接使用：

```bash
subnet_states --target 192.168.1.0/24
```

### 配置文件说明

配置文件位于 `conf/config.yaml`，主要配置项：

- **redundancy.por_threshold**: 第一层评估的端口占用率阈值（默认 0.5）
- **comprehensive.normalization**: 归一化参数
- **rate_levels**: 速率等级划分标准

---

## 📝 输出说明

### 文本格式输出

```
============================================================
子网评估结果: 192.168.1.0/24
============================================================
综合评分: 85.23/100
速率等级: level_4 (高速)
设备数量: 3

设备详情:
------------------------------------------------------------

设备 IP: 192.168.1.1
  SNMP 支持: 是
  端口占用率 (POR): 45.00%
  端口异常率 (PAR): 2.00%
  接口误码率 (IER): 0.000500
  队列丢包率 (QDR): 0.001000
  设备得分: 82.50
  风险等级: LOW

[DECISION] 子网综合评分 85.23，建议使用 高速 扫描
============================================================
```

### JSON 格式输出

```json
{
  "subnet": "192.168.1.0/24",
  "overall_score": 85.23,
  "rate_level": "level_4",
  "rate_description": "高速",
  "device_count": 3,
  "devices": [...],
  "betweenness_centrality": {...},
  "message": "..."
}
```

---

## 📊 速率等级说明

| 等级 | 得分范围 | 描述 |
|------|----------|------|
| level_5 | ≥ 90 | 极高速度，网络状态极佳 |
| level_4 | ≥ 75 | 高速，网络状态良好 |
| level_3 | ≥ 60 | 中速，网络状态一般 |
| level_2 | ≥ 40 | 低速，网络负载较高 |
| level_1 | < 40 | 极低速，网络负载很高 |

---

## 🧪 模拟数据模式

如果系统中没有安装 Nmap 或 pysnmp 依赖，程序会自动使用模拟数据进行测试。模拟数据会：
- 生成 3 台模拟设备（IP 以 .1, .254, .100 结尾）
- 为不同设备生成不同的负载指标
- 生成简单的星型拓扑结构

**注意**：使用模拟数据时日志会显示 `[MOCK]` 标记。

---

## 🔧 Scout 模块

Scout 是内置的网络探测模块，采用 **Nmap + PySNMP** 混合架构：

### 功能说明

| 功能 | 实现方式 | 说明 |
|------|----------|------|
| **设备发现** | Nmap UDP 扫描 | 扫描子网内开启 SNMP (UDP 161) 的设备 |
| **指标采集** | PySNMP | 双采样法计算 POR/PAR/IER/QDR 速率指标 |
| **拓扑构建** | PySNMP Walk | 读取路由表 (ipRouteTable) 构建网络拓扑 |

### SNMP OID 映射

Scout 使用 IP-MIB 的全局计数器采集指标：

| 指标 | OID | 说明 |
|------|-----|------|
| ipInReceives | 1.3.6.1.2.1.4.3.0 | 输入包总数 |
| ipOutRequests | 1.3.6.1.2.1.4.10.0 | 输出包总数 |
| ipInDiscards | 1.3.6.1.2.1.4.8.0 | 输入丢弃数 |
| ipInHdrErrors | 1.3.6.1.2.1.4.4.0 | 输入头部错误 |
| ipInAddrErrors | 1.3.6.1.2.1.4.5.0 | 输入地址错误 |

### 权限要求

- **UDP 扫描需要 root 权限**：`sudo python -m src.main --target 192.168.1.0/24`
- SNMP 默认使用 `public` 团体名，可通过参数修改

---

## 🧪 测试

运行基础功能测试：

```bash
python tests/test_basic.py
```

---

## ⚠️ 注意事项

1. **Nmap 安装**: 本工具依赖 Nmap 进行设备发现，请确保系统已安装 Nmap。
2. **Root 权限**: UDP 扫描需要 root 权限，建议使用 `sudo` 运行。
3. **SNMP 支持**: 只有支持 SNMP 的设备才能进行完整的状态评估。
4. **SNMP 团体名**: 默认使用 `public`，如目标设备使用其他团体名需通过参数指定。
5. **网络权限**: 执行网络探测需要相应的网络权限。
6. **配置文件**: 如果配置文件不存在或格式错误，程序会使用默认配置继续运行。
7. **模拟数据**: 如果依赖不完整，程序会自动回退到模拟数据模式，日志中会显示 `[MOCK]` 标记。
